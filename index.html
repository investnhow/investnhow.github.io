<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>InvestNow - Secure Investment Platform</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        body { background: #f4f7fa; }
        .dashboard-card { background: #fff; border-radius: 14px; padding: 2rem; box-shadow: 0 2px 16px rgba(0,0,0,0.07);}
        .summary-card { min-width: 150px; }
        .table-responsive { margin-top: 1.5rem; }
        .form-control:focus { box-shadow: 0 0 0 0.2rem #2ecc7125; }
        .nav-link.active { font-weight: bold; color: #198754 !important; }
        .landing-hero {
            background: linear-gradient(120deg, #e0ffe8 0%, #f4f7fa 100%);
            border-radius: 20px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.07);
            padding: 3rem 2rem 2rem 2rem;
            margin-bottom: 2rem;
        }
        .feature-icon {
            font-size: 2rem;
            color: #198754;
        }
        #cryptoPaymentModal .modal-body { text-align: center; }
        #cryptoQR { margin: 1rem auto; display: block; }
        .wallet-address { font-family: monospace; font-size: 1.1em; word-break: break-all; margin: 0.5em 0; }
    </style>
</head>
<body>
    <!-- ... NAVIGATION, LANDING, LOGIN, SIGNUP, DASHBOARD, FOOTER (same as your code, omitted for brevity) ... -->

    <!-- Crypto Payment Modal -->
    <div class="modal fade" id="cryptoPaymentModal" tabindex="-1" aria-labelledby="cryptoPaymentModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-success" id="cryptoPaymentModalLabel">Crypto Payment Instructions</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="cryptoPaymentDetails"></div>
            <canvas id="cryptoQR" width="180" height="180" style="display:none;"></canvas>
            <div id="depositStatus" class="mt-3"></div>
          </div>
          <div class="modal-footer justify-content-center">
            <button type="button" class="btn btn-success px-5" id="investModalBtn">Open Wallet</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script>
        // ... (all your SPA and dashboard logic as before, except payment logic below) ...

        // --- Payment Handling: Automatic Confirmation via Backend ---
        let polling = null;
        let currentDeposit = null;
        const backendUrl = "http://localhost:3000"; // Change if your backend is elsewhere

        document.getElementById('investmentForm').onsubmit = async function(e) {
            e.preventDefault();
            const amountInput = document.getElementById('amount');
            const cryptoType = document.getElementById('cryptoType').value;
            const amount = parseFloat(amountInput.value);
            if (isNaN(amount) || amount < 100) {
                amountInput.classList.add('is-invalid');
                return;
            }
            amountInput.classList.remove('is-invalid');
            if (!currentUser) {
                alert("You must be logged in to invest.");
                return;
            }

            // 1. Ask backend for deposit address
            const res = await fetch(`${backendUrl}/api/create-deposit`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser, crypto: cryptoType.toLowerCase(), amount })
            });
            const data = await res.json();
            currentDeposit = { username: currentUser, amount, coin: cryptoType.toLowerCase(), address: data.address };

            // 2. Show modal with address and QR
            let html = `
                <div>
                  <p>Send exactly <strong>${amount} ${cryptoType}</strong> to this wallet address:</p>
                  <div class="wallet-address">${data.address}</div>
                  <p>Or scan the QR code below with your ${cryptoType} wallet app.</p>
                </div>
            `;
            document.getElementById('cryptoPaymentDetails').innerHTML = html;
            new QRious({ element: document.getElementById('cryptoQR'), value: data.address, size: 180 });
            document.getElementById('cryptoQR').style.display = 'block';
            document.getElementById('depositStatus').innerHTML = "Waiting for payment confirmation...";

            const modal = new bootstrap.Modal(document.getElementById('cryptoPaymentModal'));
            modal.show();

            // 3. Poll backend for payment confirmation
            if (polling) clearInterval(polling);
            polling = setInterval(async () => {
                const statusRes = await fetch(`${backendUrl}/api/deposit-status/${currentUser}`);
                const status = await statusRes.json();
                if (status.confirmed) {
                    document.getElementById('depositStatus').innerHTML = `<b style="color:green">Deposit received! Amount: ${status.amount}, TXID: ${status.txid}</b>`;
                    // Add to investments
                    const today = new Date();
                    const dateStr = today.toISOString().slice(0,10);
                    let investments = getInvestments();
                    const estimatedReturn = +(amount * 0.06).toFixed(2);
                    investments.unshift({
                        date: dateStr,
                        amount: status.amount,
                        return: estimatedReturn,
                        status: 'Active'
                    });
                    saveInvestments(investments);
                    renderInvestments();
                    updateTotals();
                    // Show success alert
                    const alert = document.getElementById('formAlert');
                    alert.classList.remove('d-none');
                    setTimeout(() => alert.classList.add('d-none'), 2000);
                    clearInterval(polling);
                    modal.hide();
                }
            }, 10000); // poll every 10 seconds
        };

        // Open wallet app with prefilled address (and amount for BTC)
        document.getElementById('investModalBtn').onclick = function() {
            if (!currentDeposit) return;
            let uri = "";
            if (currentDeposit.coin === "btc") {
                uri = `bitcoin:${currentDeposit.address}?amount=${currentDeposit.amount}`;
            } else if (currentDeposit.coin === "eth") {
                uri = `ethereum:${currentDeposit.address}`;
            } else if (currentDeposit.coin === "usdt") {
                uri = currentDeposit.address;
            }
            window.location.href = uri;
        };

        // ... (rest of your SPA/dashboard logic as before) ...
    </script>
</body>
</html>
